name: Build xformers Windows (Final Optimized)

on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: 'Git Ref (Tag/Branch/Commit)'
        required: true
        default: 'v0.0.33.post2'
        type: string
      python_version:
        description: 'Python Version'
        required: true
        default: '3.11'
        type: choice
        options:
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'
          - '3.14'
      cuda_short_version:
        description: 'CUDA Short Version (e.g. 130, 126, 118)'
        required: true
        default: '130'
        type: string

jobs:
  build_wheels:
    name: Win-Py${{ inputs.python_version }}-cu${{ inputs.cuda_short_version }}
    runs-on: windows-2022
    
    env:
      # [新] 强制开启 CUDA 构建
      FORCE_CUDA: 1
      # [新] 指定 Release 模式
      XFORMERS_BUILD_TYPE: "Release"
      # [新] 极为重要：设置极短的临时目录以避免 Windows 路径过长报错
      TMPDIR: "./x"
      
      MAX_JOBS: 4
      DISTUTILS_USE_SDK: 1
      XFORMERS_PACKAGE_FROM: "wheel-${{ inputs.git_ref }}"
      NVCC_FLAGS: "-allow-unsupported-compiler"

    steps:
      - name: Enable Windows long paths
        run: git config --system core.longpaths true

      # [新] 创建短临时目录 (Workaround for longpaths)
      - name: Create Short Temp Dir
        shell: bash
        run: |
          mkdir -p x
          echo "Created temp dir at ./x"
          # 验证路径长度是否足够短
          python -c "import os; print(f'Temp dir: {os.path.abspath(\"./x\")}')"

      - name: Resolve CUDA & Arch Info
        id: setup_info
        shell: python
        run: |
          import os, sys
          cu_short = "${{ inputs.cuda_short_version }}"
          
          # 版本映射
          version_map = {
            "130": "13.0.1", "129": "12.9.1", "128": "12.8.1",
            "126": "12.8.1", "124": "12.4.1", "121": "12.1.1", "118": "11.8.0"
          }
          full_version = version_map.get(cu_short)
          if not full_version:
              print(f"::error::Unknown CUDA version {cu_short}")
              sys.exit(1)

          # 架构列表
          base_arch = "7.5 8.0+PTX"
          if int(cu_short) >= 130:
              arch_list = f"{base_arch} 9.0a 10.0a 10.3a 11.0a 12.0a 12.1a"
          elif int(cu_short) >= 120:
              arch_list = f"{base_arch} 8.6 8.9 9.0a"
          else:
              arch_list = f"{base_arch} 8.6"

          with open(os.environ['GITHUB_OUTPUT'], "a") as fp:
              fp.write(f"CUDA_VERSION={full_version}\n")
          with open(os.environ['GITHUB_ENV'], "a") as fp:
              fp.write(f"TORCH_CUDA_ARCH_LIST={arch_list}\n")

      - name: Install CUDA Toolkit
        uses: N-Storm/cuda-toolkit@v0.2.28
        with:
          cuda: ${{ steps.setup_info.outputs.CUDA_VERSION }}
          method: network

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python_version }}

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Remove link.exe
        shell: bash
        run: rm /usr/bin/link

      - name: Checkout xformers
        uses: actions/checkout@v4
        with:
          repository: facebookresearch/xformers
          ref: ${{ inputs.git_ref }}
          submodules: recursive
          fetch-depth: 0

      - name: HACKFIX for cutlass
        shell: bash
        run: |
          TARGET="third_party/cutlass/include/cutlass/gemm/kernel/sm90_gemm_tma_warpspecialized_pingpong.hpp"
          if [ -f "$TARGET" ]; then rm -f "$TARGET" && touch "$TARGET"; fi

      - name: Install Dependencies & PyTorch
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install ninja wheel setuptools numpy
          
          CU_VER="${{ inputs.cuda_short_version }}"
          echo "Installing PyTorch for cu$CU_VER..."
          
          # 优先安装顺序：Stable -> Nightly -> Test
          # 针对 cu130，Nightly 成功率最高
          URL_STABLE="https://download.pytorch.org/whl/cu${CU_VER}"
          URL_NIGHTLY="https://download.pytorch.org/whl/nightly/cu${CU_VER}"
          
          (pip install torch --index-url $URL_STABLE) || \
          (pip install torch --pre --index-url $URL_NIGHTLY) || \
          (pip install torch --pre --index-url https://download.pytorch.org/whl/test/cu${CU_VER})
          
          python -c "import torch; print(f'Torch: {torch.__version__}, CUDA: {torch.version.cuda}')"

      - name: Build Wheel
        shell: cmd
        run: |
          set CMAKE_GENERATOR=Ninja
          python setup.py bdist_wheel

      # [新] 验证步骤：安装生成的包并检查是否能导入
      - name: Verify Build
        shell: bash
        run: |
          pip install dist/*.whl
          
          echo "Running xformers info..."
          # 切换出源码目录以防止导入冲突
          cd ..
          XFORMERS_MORE_DETAILS=1 python -m xformers.info

      - name: Upload Wheel
        uses: actions/upload-artifact@v4
        with:
          name: xformers-win-cu${{ inputs.cuda_short_version }}-py${{ inputs.python_version }}
          path: dist/*.whl
