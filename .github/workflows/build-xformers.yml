name: Build xformers on Windows (Custom Env)

on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: 'Git Ref (Tag/Branch/Commit)'
        required: true
        default: 'v0.0.33.post2'
        type: string
      python_version:
        description: 'Python Version'
        required: true
        default: '3.11'
        type: choice
        options:
          - '3.10'
          - '3.11'
          - '3.12'
      # 这里输入改为短版本号，以匹配参考代码的字典键值 (例如 130, 128, 118)
      cuda_short_version:
        description: 'CUDA Short Version (e.g. 130, 126, 118)'
        required: true
        default: '130'
        type: string

jobs:
  build_wheels:
    name: Py${{ inputs.python_version }}-cu${{ inputs.cuda_short_version }}
    runs-on: windows-2022
    
    env:
      # 显卡架构：根据需要调整。7.5 = Turning, 8.0 = Ampere, 8.6 = Ampere, 8.9 = Ada Lovelace, 9.0 = Hopper, 12.0 = Backwell
      TORCH_CUDA_ARCH_LIST: "7.5;8.0;8.6;8.9;9.0;12.0"
      MAX_JOBS: 4
      DISTUTILS_USE_SDK: 1
      XFORMERS_PACKAGE_FROM: "wheel-v${{ inputs.git_ref }}"
      # 允许新版编译器
      NVCC_FLAGS: "-allow-unsupported-compiler"

    steps:
      # 1. 开启 Windows 长路径支持 (在 checkout 之前执行)
      - name: Enable Windows long paths
        run: git config --system core.longpaths true

      # 2. 解析 CUDA 版本 (移植自参考代码)
      - name: Resolve CUDA Version
        id: cuda_info
        shell: python
        run: |
          import os
          import sys
          
          # 输入的短版本，如 "130"
          cushort = "${{ inputs.cuda_short_version }}"
          
          # 移植的映射字典
          version_map = {
            "130": "13.0.1",
            "129": "12.9.1",
            "128": "12.8.1",
            "126": "12.8.1", # 参考代码注：用 12.8 构建 12.6
            "118": "11.8.0"
          }
          
          full_version = version_map.get(cushort)
          if not full_version:
              print(f"Error: Unknown CUDA short version {cushort}")
              sys.exit(1)
              
          print(f"Mapping {cushort} to {full_version}")
          
          # 输出到 GITHUB_OUTPUT
          with open(os.environ['GITHUB_OUTPUT'], "a") as fp:
              fp.write(f"CUDA_VERSION={full_version}\n")
              fp.write(f"CUDA_SHORT={cushort}\n")

      # 3. 安装 CUDA Toolkit (使用 N-Storm 分支)
      - name: Install CUDA Toolkit
        id: cuda-toolkit
        uses: N-Storm/cuda-toolkit@v0.2.28
        with:
          cuda: ${{ steps.cuda_info.outputs.CUDA_VERSION }}
          method: network

      # 4. 配置 CUDA 环境变量
      - name: Setup CUDA Environment
        shell: bash
        run: |
          echo "Installed cuda version is: ${{ steps.cuda-toolkit.outputs.cuda }}"
          echo "Cuda install location: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
          echo "CUDA_HOME=${{ steps.cuda-toolkit.outputs.CUDA_PATH }}" >> ${GITHUB_ENV}
          echo "CUDA_PATH=${{ steps.cuda-toolkit.outputs.CUDA_PATH }}" >> ${GITHUB_ENV}

      # 5. 安装 Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ inputs.python_version }}

      # 6. 配置 MSVC 环境
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # 7. 移除 Git Bash 的 link.exe (解决与 MSVC link.exe 冲突的关键步骤)
      - name: Remove link.exe
        shell: bash
        run: rm /usr/bin/link

      # 8. 检出代码
      - name: Checkout xformers
        uses: actions/checkout@v4
        with:
          repository: facebookresearch/xformers
          ref: ${{ inputs.git_ref }}
          submodules: recursive
          fetch-depth: 0

      # 9. 安装依赖和 PyTorch
      - name: Install Build Dependencies & PyTorch
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install ninja wheel setuptools
          
          # 构造 PyTorch 下载链接
          # 假设 PyTorch 官方源格式为 cu130 (即 inputs.cuda_short_version)
          CU_VER="${{ inputs.cuda_short_version }}"
          
          echo "Installing PyTorch for CUDA ${CU_VER}..."
          
          # 策略：先尝试 Nightly (因为 cu130 很新)，如果失败尝试 Test/Pre，最后尝试 Stable
          # 如果您确定只需要 Nightly，可以简化这行
          pip install torch --index-url https://download.pytorch.org/whl/cu${CU_VER} || \
          pip install torch --pre --index-url https://download.pytorch.org/whl/nightly/cu${CU_VER}
          
          python -c "import torch; print(f'Torch Ver: {torch.__version__}'); print(f'CUDA Ver: {torch.version.cuda}')"

      # 10. 编译 Wheel
      - name: Build Wheel
        shell: cmd
        run: |
          :: 再次确认 Ninja
          set CMAKE_GENERATOR=Ninja
          
          python setup.py bdist_wheel

      # 11. 上传产物
      - name: List and Upload
        shell: bash
        run: ls -R dist/
        
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: xformers-win-cu${{ inputs.cuda_short_version }}-py${{ inputs.python_version }}
          path: dist/*.whl
